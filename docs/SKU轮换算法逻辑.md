# SKU轮换算法完整逻辑

## 一、算法目标

在7天周期内，确保所有SKU都被盘点，同时每天控制在20-30分钟内完成。

## 二、算法输入

- **品类范围**：手机、平板（仅高净值商品）
- **时间约束**：
  - 目标时间：20分钟/天
  - 最大时间：30分钟/天
- **周期天数**：7天（可配置）

## 三、算法流程

### 第一步：获取候选SKU

获取所有需要盘点的SKU：
- 筛选条件：仅包含配置的品类（手机、平板）
- 状态：未在周期内盘点过的SKU
- 包含：新入库的商品（动态加入）

### 第二步：计算优先级分数

对每个SKU计算优先级分数，用于排序选择。

**优先级计算公式：**

```
优先级分数 = 时间因子×30% + 价值因子×25% + 新品因子×20% + 销量因子×15% + 风险因子×10%
```

**各因子计算方式：**

1. **时间因子（30%）**
   - 计算：距离上次盘点天数
   - 归一化：min(天数/7, 1.0) × 0.3
   - 说明：天数越大，优先级越高（最多7天为满分）

2. **价值因子（25%）**
   - 计算：商品价格
   - 归一化：min(价格/10000, 1.0) × 0.25
   - 说明：价格越高，优先级越高（最多10000元为满分）

3. **新品因子（20%）**
   - 计算：是否新商品
   - 值：新商品 = 0.2，非新品 = 0
   - 说明：新商品优先级最高

4. **销量因子（15%）**
   - 计算：最近销量
   - 归一化：min(销量/100, 1.0) × 0.15
   - 说明：销量越高，优先级越高（最多100件为满分）

5. **风险因子（10%）**
   - 计算：历史差异率
   - 归一化：min(差异率, 1.0) × 0.1
   - 说明：历史差异率越高，优先级越高

**优先级分数范围：** 0.0 ~ 1.0

### 第三步：按优先级排序

将所有SKU按优先级分数从高到低排序，确保重要SKU优先被选择。

### 第四步：遍历选择SKU（同步决定盘点方式）

从高优先级开始遍历，对每个SKU执行以下逻辑：

#### 4.1 计算两种盘点方式的时间

- **扫码时间** = SKU库存数量 × 5秒/件（转换为分钟）
- **填数时间** = SKU库存数量 × 1秒/件（转换为分钟）

#### 4.2 动态决定盘点方式

**决策逻辑：**

1. **优先尝试扫码**
   - 如果：累计时间 + 扫码时间 ≤ 30分钟
   - 则：使用扫码方式
   - 该SKU耗时 = 扫码时间

2. **时间不够时改用填数**
   - 如果：累计时间 + 扫码时间 > 30分钟
   - 且：累计时间 + 填数时间 ≤ 30分钟
   - 则：改用填数方式
   - 该SKU耗时 = 填数时间

3. **时间完全不够则停止**
   - 如果：累计时间 + 填数时间 > 30分钟
   - 则：不选择该SKU，停止遍历（后续SKU也不选择）

#### 4.3 更新累计时间

如果SKU被选中：
- 将该SKU加入选中列表（标记盘点方式：扫码/填数）
- 累计时间 += 该SKU耗时

### 第五步：生成任务

- 创建库存快照（记录盘点开始时的库存状态）
- 生成日盘任务（包含选中的SKU列表及各自的盘点方式）
- 推送到移动端

## 四、算法特点

### 1. 优先级驱动
- 重要SKU（新品、高价值、久未盘点、高销量、高风险）优先被选择
- 确保重要商品及时盘点

### 2. 时间约束
- 严格控制每天盘点时间在30分钟内
- 通过动态调整盘点方式（扫码→填数）来平衡准确性和效率

### 3. 动态调整
- 不是固定使用扫码或填数
- 根据剩余时间动态选择最合适的盘点方式
- 在时间允许的情况下优先使用扫码（更准确）

### 4. 周期覆盖
- 7天周期内，所有SKU都会被遍历到
- 优先级高的SKU会在前面几天完成
- 优先级低的SKU会在后面几天完成

## 五、示例场景

### 场景1：正常选择

**当前累计时间：0分钟**

SKU A：优先级0.9，库存10件
- 扫码时间：10 × 5秒 = 50秒 ≈ 0.83分钟
- 填数时间：10 × 1秒 = 10秒 ≈ 0.17分钟
- 判断：0 + 0.83 = 0.83 ≤ 30 → 用扫码
- 累计时间：0.83分钟

SKU B：优先级0.8，库存20件
- 扫码时间：20 × 5秒 = 100秒 ≈ 1.67分钟
- 填数时间：20 × 1秒 = 20秒 ≈ 0.33分钟
- 判断：0.83 + 1.67 = 2.5 ≤ 30 → 用扫码
- 累计时间：2.5分钟

### 场景2：时间紧张，改用填数

**当前累计时间：28分钟**

SKU C：优先级0.7，库存50件
- 扫码时间：50 × 5秒 = 250秒 ≈ 4.17分钟
- 填数时间：50 × 1秒 = 50秒 ≈ 0.83分钟
- 判断：
  - 扫码：28 + 4.17 = 32.17 > 30 → 不能用扫码
  - 填数：28 + 0.83 = 28.83 ≤ 30 → 改用填数
- 累计时间：28.83分钟

### 场景3：时间完全不够，停止选择

**当前累计时间：29.5分钟**

SKU D：优先级0.6，库存30件
- 扫码时间：30 × 5秒 = 150秒 = 2.5分钟
- 填数时间：30 × 1秒 = 30秒 = 0.5分钟
- 判断：
  - 扫码：29.5 + 2.5 = 32 > 30 → 不能用扫码
  - 填数：29.5 + 0.5 = 30 ≤ 30 → 可以用填数
- 结果：用填数，累计时间：30分钟

**继续下一个SKU E：优先级0.5，库存40件**
- 扫码时间：40 × 5秒 = 200秒 ≈ 3.33分钟
- 填数时间：40 × 1秒 = 40秒 ≈ 0.67分钟
- 判断：
  - 扫码：30 + 3.33 = 33.33 > 30 → 不能用扫码
  - 填数：30 + 0.67 = 30.67 > 30 → 不能用填数
- 结果：不选择该SKU，停止遍历

## 六、关键决策点

| 决策点 | 条件 | 结果 |
|--------|------|------|
| 使用扫码 | 累计时间 + 扫码时间 ≤ 30分钟 | 扫码盘点 |
| 改用填数 | 累计时间 + 扫码时间 > 30分钟<br/>且 累计时间 + 填数时间 ≤ 30分钟 | 填数盘点 |
| 停止选择 | 累计时间 + 填数时间 > 30分钟 | 不选择，停止遍历 |

## 七、算法输出

- **选中SKU列表**：包含SKU信息和盘点方式（扫码/填数）
- **预估总时间**：所有选中SKU的累计耗时
- **库存快照**：盘点开始时的库存状态
- **日盘任务**：推送到移动端的任务信息
