# 日盘系统流程图

## 一、业务流程总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        日盘业务流程                              │
└─────────────────────────────────────────────────────────────────┘

【配置阶段】                    【任务生成】                    【盘点执行】
     │                              │                              │
     ├─ PC后台品类配置               ├─ 每日04:00自动生成           ├─ 移动端查看任务
     ├─ 周期参数设置                 ├─ SKU优先级计算               ├─ 开始盘点
     ├─ 可行性校验                   ├─ 盘点方式决策                ├─ 扫码/填数
     └─ 保存配置                     ├─ 库存快照                    └─ 完成盘点
                                      └─ 推送到移动端
                                            
【差异确认】                    【签名提交】                    【周期保障】
     │                              │                              │
     ├─ 同步库存变化                 ├─ 签名确认                    ├─ 周期开始前验证
     ├─ 计算差异                     ├─ 提交完成                    ├─ 周期进行中监控
     ├─ 填写原因                     └─ 生成报告                    └─ 最后几天兜底
     └─ 确认差异
```

---

## 二、详细流程图

### 2.1 配置管理流程

```
┌─────────────────────────────────────────────────────────────┐
│                    PC后台 - 品类配置流程                       │
└─────────────────────────────────────────────────────────────┘

开始
  │
  ├─→ 进入品类配置页面
  │
  ├─→ 选择日盘品类
  │   ├─ 手机 ✓
  │   ├─ 平板 ✓
  │   ├─ 笔记本
  │   ├─ 智能手表
  │   └─ 耳机
  │
  ├─→ 配置周期参数
  │   ├─ 周期天数：7天
  │   ├─ 每天目标时间：20分钟
   │   └─ 每天最大时间：30分钟
  │
  ├─→ 实时校验
  │   ├─ 计算预估SKU数量
  │   ├─ 计算预估总时间
  │   ├─ 计算可行性比例
  │   └─ 判断风险等级
  │
  ├─→ 风险等级判断
  │   ├─ LOW (≤80%)     → 可以保存 ✓
  │   ├─ MEDIUM (≤100%) → 可以保存，提示注意
  │   ├─ HIGH (≤120%)   → 可以保存，提示风险
  │   └─ CRITICAL (>120%) → 禁止保存 ✗
  │
  ├─→ 保存配置
  │   └─ 配置生效
  │
  └─→ 结束
```

### 2.2 任务生成流程

```
┌─────────────────────────────────────────────────────────────┐
│              每日04:00 - 任务自动生成流程                      │
└─────────────────────────────────────────────────────────────┘

定时任务触发（04:00）
  │
  ├─→ 获取配置的品类
  │   └─ 从品类配置表读取
  │
  ├─→ 获取门店所有SKU
  │   ├─ 筛选：仅配置的品类
  │   ├─ 状态：未在周期内盘点
  │   └─ 包含：新入库的商品
  │
  ├─→ 计算SKU优先级
  │   ├─ 时间因子：距离上次盘点天数
  │   ├─ 价值因子：商品价格
  │   ├─ 销量因子：最近销量
  │   ├─ 新品因子：是否新商品
  │   └─ 风险因子：历史差异率
  │
  ├─→ 按优先级排序
  │
  ├─→ 选择当日SKU
  │   ├─ 从高优先级开始选择
  │   ├─ 累计时间 ≤ 20分钟（目标）
   │   └─ 最多不超过30分钟（上限）
  │
  ├─→ 决定盘点方式
  │   ├─ 高价值(≥500元) → 扫码
  │   ├─ 有序列号 → 扫码
  │   ├─ 数量大(>50件) → 混合策略
  │   └─ 其他 → 填数
  │
  ├─→ 创建库存快照
  │   └─ 记录盘点开始时的库存状态
  │
  ├─→ 生成日盘任务
  │   ├─ 任务ID：PDD{日期}0001
  │   ├─ 状态：PENDING
  │   ├─ 截止时间：次日03:59:59
  │   └─ 推送到移动端
  │
  └─→ 结束
```

### 2.3 盘点执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                  移动端 - 盘点执行流程                          │
└─────────────────────────────────────────────────────────────┘

查看任务列表
  │
  ├─→ 点击"开始盘点"
  │
  ├─→ 判断任务状态
  │   ├─ PENDING → 显示"操作说明"弹窗
  │   └─ IN_PROGRESS → 显示"继续盘点"确认
  │
  ├─→ 进入盘点页面
  │   ├─ Tab：未盘点
  │   └─ Tab：已盘点
  │
  ├─→ 盘点操作
  │   │
  │   ├─→ 方式一：扫码盘点
  │   │   ├─ 点击SKU卡片
  │   │   ├─ 展开商品列表
  │   │   ├─ 扫描序列号
  │   │   ├─ 系统识别
  │   │   │   ├─ 正常 → 移到"已盘点"
  │   │   │   ├─ 重复 → 提示重复
  │   │   │   └─ 溢余 → 记录为溢余
  │   │   └─ 实时保存
  │   │
  │   └─→ 方式二：填数盘点
  │       ├─ 点击SKU卡片
  │       ├─ 输入实际数量
  │       ├─ 系统计算差异
  │       └─ 实时保存
  │
  ├─→ 检查完成状态
  │   ├─ 未完成 → 继续盘点
  │   └─ 已完成 → 点击"完成盘点"
  │
  ├─→ 确认完成
  │   └─ 进入"确认"环节
  │
  └─→ 结束
```

### 2.4 差异确认流程

```
┌─────────────────────────────────────────────────────────────┐
│                  移动端 - 差异确认流程                          │
└─────────────────────────────────────────────────────────────┘

进入确认页面
  │
  ├─→ 系统自动检测差异
  │   ├─ 短缺：任务中有，实际未找到
  │   ├─ 溢余：实际找到，任务中没有
  │   └─ 数量差异：填数盘点不一致
  │
  ├─→ 点击"立即同步"
  │   ├─ 同步盘点期间的销售记录
  │   ├─ 同步盘点期间的退货记录
  │   ├─ 同步盘点期间的调拨记录
  │   └─ 动态比对库存变化
  │
  ├─→ 系统自动标记withdraw
  │   ├─ 已销售 → 标记为withdraw
  │   ├─ 已调拨 → 标记为withdraw
  │   └─ 已返仓 → 标记为withdraw
  │
  ├─→ 查看差异列表（按SKU分组）
  │   ├─ 显示：SKU名称、图片、价格
  │   ├─ 统计：短缺数、溢余数、withdraw数
  │   └─ 状态：待确认 / 已确认
  │
  ├─→ 点击差异项 → 进入详情页
  │   ├─ 显示具体差异商品
  │   ├─ 显示系统检测的原因（如果有）
  │   └─ 填写原因、上传凭证
  │
  ├─→ 填写差异原因
  │   ├─ 选择原因类型
  │   │   ├─ 损耗（Damage/Loss）
  │   │   ├─ 清点错误（Counting Error）
  │   │   └─ 其他（需填写备注）
  │   ├─ 上传凭证图片（可选）
  │   └─ 确认差异
  │
  ├─→ 返回列表
  │   └─ 自动定位到第一个未确认项
  │
  ├─→ 所有差异确认完成
  │   └─ "提交"按钮可点击
  │
  └─→ 进入签名环节
```

### 2.5 签名提交流程

```
┌─────────────────────────────────────────────────────────────┐
│                  移动端 - 签名提交流程                          │
└─────────────────────────────────────────────────────────────┘

所有差异确认完成
  │
  ├─→ 点击"提交"
  │
  ├─→ 进入签名页面
  │
  ├─→ 在签名区域签名（手写）
  │
  ├─→ 系统保存签名（Base64格式）
  │
  ├─→ 点击"确认提交"
  │
  ├─→ 系统处理
  │   ├─ 保存盘点结果
  │   ├─ 更新任务状态：COMPLETED
  │   ├─ 更新SKU最后盘点时间
  │   ├─ 更新库存快照
  │   └─ 生成盘点报告
  │
  └─→ 提交完成
```

### 2.6 新商品入库处理流程

```
┌─────────────────────────────────────────────────────────────┐
│              周期进行中 - 新商品入库处理流程                     │
└─────────────────────────────────────────────────────────────┘

检测到新商品入库
  │
  ├─→ 判断是否在配置的品类范围内
  │   ├─ 否 → 忽略
  │   └─ 是 → 继续处理
  │
  ├─→ 计算时间成本
  │   └─ 估算加入当前任务的时间
  │
  ├─→ 评估对周期的影响
  │   └─ 计算可行性比例
  │
  ├─→ 智能判断
  │   │
  │   ├─→ 时间影响 ≤ 5分钟
  │   │   ├─ 自动加入当前任务
  │   │   └─ Toast提示："检测到新商品，已自动加入"
  │   │
  │   ├─→ 时间影响 5-15分钟
  │   │   ├─ 弹窗询问用户
  │   │   ├─ 选项："加入今日任务" / "延迟到明天"
  │   │   └─ 用户决策
  │   │
  │   └─→ 时间影响 > 15分钟
  │       ├─ 自动延迟到明天
  │       └─ Banner提示："新商品数量较大，已安排到明日"
  │
  └─→ 如果加入当前任务
      ├─ 重新计算优先级
      ├─ 动态调整当日SKU列表
      └─ 更新预估时间
```

### 2.7 周期覆盖保障流程

```
┌─────────────────────────────────────────────────────────────┐
│                   周期覆盖保障机制流程                          │
└─────────────────────────────────────────────────────────────┘

【第一层：周期开始前验证】
  │
  ├─→ 获取周期开始时的所有SKU
  │
  ├─→ 计算每个SKU的预估耗时
  │
  ├─→ 计算周期总容量
  │   └─ 最大时间 × 周期天数
  │
  ├─→ 判断可行性
  │   ├─ 可行 (≤100%) → 正常分配
  │   ├─ 略超 (≤120%) → 允许最后几天超时
  │   └─ 超出 (>120%) → 调整周期或采用混合策略
  │
  └─→ 生成调整建议

【第二层：周期进行中监控】
  │
  ├─→ 每天监控进度
  │   ├─ 计算已用时间
  │   ├─ 计算剩余SKU
  │   ├─ 计算剩余时间需求
  │   └─ 计算剩余容量
  │
  ├─→ 评估风险等级
  │   ├─ LOW (≤80%) → 进度正常
  │   ├─ MEDIUM (≤100%) → 进度紧张
  │   ├─ HIGH (≤120%) → 进度严重滞后
  │   └─ CRITICAL (>120%) → 无法完成
  │
  ├─→ 生成应对措施
  │   ├─ MEDIUM → 允许最后几天超时
  │   ├─ HIGH → 优先高价值SKU，低价值改为填数
  │   └─ CRITICAL → 延迟低优先级SKU，延长周期
  │
  └─→ 执行应对措施

【第三层：最后几天兜底】
  │
  ├─→ 最后2天强制分配
  │
  ├─→ 按优先级排序剩余SKU
  │
  ├─→ 判断是否可全部完成
  │   ├─ 可完成 (≤130%) → 允许超时，全部完成
  │   └─ 不可完成 (>130%) → 只保证高优先级
  │
  ├─→ 分配策略
  │   ├─ 可完成 → 平均分配，允许超时30%
  │   └─ 不可完成 → 高优先级完成，低优先级延迟
  │
  └─→ 确保重要SKU完成
```

---

## 三、系统架构流程

```
┌─────────────────────────────────────────────────────────────┐
│                      系统架构流程                              │
└─────────────────────────────────────────────────────────────┘

【PC后台层】
  │
  ├─→ 品类配置管理
  │   ├─ 品类选择
  │   ├─ 参数配置
  │   ├─ 实时校验
  │   └─ 配置保存
  │
  └─→ 盘点计划管理
      ├─ 计划创建
      ├─ 计划查询
      └─ 计划详情

【定时任务层】
  │
  └─→ 任务生成服务（每日04:00）
      ├─ SKU选择算法
      ├─ 优先级计算
      ├─ 盘点方式决策
      ├─ 库存快照创建
      └─ 任务推送

【移动端层】
  │
  ├─→ 任务列表
  │   ├─ 今日任务
  │   └─ 历史任务
  │
  ├─→ 盘点执行
  │   ├─ 扫码盘点
  │   ├─ 填数盘点
  │   └─ 进度保存
  │
  ├─→ 差异确认
  │   ├─ 差异同步
  │   ├─ 原因填写
  │   └─ 差异确认
  │
  └─→ 签名提交
      ├─ 签名确认
      └─ 提交完成

【后端服务层】
  │
  ├─→ 库存快照服务
  │   └─ 快照创建、更新、查询
  │
  ├─→ 差异计算服务
  │   ├─ 动态比对
  │   ├─ withdraw标记
  │   └─ 差异分类
  │
  ├─→ 周期保障服务
  │   ├─ 可行性验证
  │   ├─ 进度监控
  │   └─ 强制分配
  │
  └─→ 报告生成服务
      ├─ 盘点报告
      └─ 统计分析
```

---

## 四、数据流转流程

```
┌─────────────────────────────────────────────────────────────┐
│                      数据流转流程                              │
└─────────────────────────────────────────────────────────────┘

配置数据
  │
  └─→ 品类配置表
      │
      └─→ 任务生成服务
          │
          └─→ 日盘任务表
              │
              └─→ 移动端应用
                  │
                  ├─→ 盘点结果（本地存储）
                  │   │
                  │   └─→ 实时同步到服务器
                  │
                  └─→ 差异计算服务
                      │
                      └─→ 差异确认
                          │
                          └─→ 签名提交
                              │
                              └─→ 盘点报告表
                                  │
                                  └─→ 下一周期任务生成
```

---

## 五、关键决策点

### 5.1 SKU选择决策树

```
开始
  │
  ├─→ 获取所有未盘点SKU
  │
  ├─→ 计算优先级分数
  │   ├─ 时间因子
  │   ├─ 价值因子
  │   ├─ 销量因子
  │   ├─ 新品因子
  │   └─ 风险因子
  │
  ├─→ 按优先级排序
  │
  ├─→ 选择SKU
  │   ├─ 累计时间 ≤ 20分钟？ → 继续选择
   │   ├─ 累计时间 ≤ 30分钟？ → 允许超时，继续选择
   │   └─ 累计时间 > 30分钟？ → 停止选择
  │
  └─→ 返回选中的SKU列表
```

### 5.2 盘点方式决策树

```
开始
  │
  ├─→ 商品价格 ≥ 500元？
  │   └─ 是 → 扫码
  │
  ├─→ 有序列号？
  │   └─ 是 → 扫码
  │
  ├─→ 库存数量 > 50件？
  │   └─ 是 → 混合策略（抽样扫码+批量填数）
  │
  └─→ 其他 → 填数
```

### 5.3 新商品入库决策树

```
检测到新商品入库
  │
  ├─→ 在配置的品类范围内？
  │   └─ 否 → 忽略
  │
  ├─→ 计算时间成本
  │
  ├─→ 时间影响 ≤ 5分钟？
  │   └─ 是 → 自动加入，Toast提示
  │
  ├─→ 时间影响 5-15分钟？
  │   └─ 是 → 弹窗询问用户
  │
  └─→ 时间影响 > 15分钟？
      └─ 是 → 自动延迟到明天，Banner提示
```

---

## 六、异常处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                      异常处理流程                              │
└─────────────────────────────────────────────────────────────┘

【异常1：周期无法完成】
  │
  ├─→ 预防：配置时校验
  │   └─ 可行性比例 > 120% → 禁止保存
  │
  ├─→ 监控：周期进行中实时监控
  │   └─ 提前预警，生成应对措施
  │
  └─→ 兜底：最后几天强制分配
      ├─ 允许超时
      ├─ 优先高价值SKU
      └─ 低优先级延迟到下周期

【异常2：盘点中断】
  │
  ├─→ 本地自动保存进度
  │
  ├─→ 支持断点续传
  │
  └─→ 恢复时显示"继续盘点"提示

【异常3：新商品大量入库】
  │
  ├─→ 智能判断时间影响
  │
  ├─→ 分级处理
  │   ├─ 小影响 → 自动加入
  │   ├─ 中影响 → 询问用户
  │   └─ 大影响 → 自动延迟
  │
  └─→ 动态调整当日任务
```

---

## 七、时间线视图

```
周期时间线（7天）

Day 1 (周一)          Day 2 (周二)          Day 3 (周三)          ... Day 7 (周日)
    │                     │                     │                        │
04:00 生成任务        04:00 生成任务        04:00 生成任务         04:00 生成任务
    │                     │                     │                        │
    ├─ SKU选择            ├─ SKU选择            ├─ SKU选择               ├─ SKU选择
    ├─ 优先级计算          ├─ 优先级计算          ├─ 优先级计算             ├─ 优先级计算
    └─ 推送到移动端        └─ 推送到移动端        └─ 推送到移动端           └─ 推送到移动端
    │                     │                     │                        │
    ├─ 盘点执行            ├─ 盘点执行            ├─ 盘点执行               ├─ 盘点执行
    ├─ 差异确认            ├─ 差异确认            ├─ 差异确认               ├─ 差异确认
    └─ 签名提交            └─ 签名提交            └─ 签名提交               └─ 签名提交
    │                     │                     │                        │
次日03:59 截止        次日03:59 截止        次日03:59 截止         次日03:59 截止
    │                     │                     │                        │
    └─────────────────────┴─────────────────────┴────────────────────────┘
                         周期结束，所有SKU盘点完成
```

---

## 八、总结

日盘系统通过以下关键流程确保高效、准确完成盘点：

1. **配置管理**：PC后台配置品类和参数，实时校验可行性
2. **任务生成**：每日04:00自动生成，智能选择SKU，决定盘点方式
3. **盘点执行**：移动端扫码/填数，实时保存进度
4. **差异确认**：同步库存变化，动态比对，准确识别真实差异
5. **签名提交**：签名确认，提交完成，生成报告
6. **周期保障**：三层保障机制，确保所有SKU都被盘点

整个流程形成了完整的闭环，既保证了业务需求，又控制了时间成本。
